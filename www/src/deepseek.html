<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ä¸ªäººåšå®¢</title>

    <!-- Viewport & color scheme è§†å£ä¸é¢œè‰²æ–¹æ¡ˆ -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#121212"
    />

    <!-- Stylesheets æ ·å¼è¡¨ -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism.css"
    />
    <link rel="stylesheet" href="../statics/css/deepseek.css" />
    <style>
      .context-reminder.subtle {
        font-size: 0.8em;
        opacity: 0.6;
        max-width: none;
        margin-top: 6px;
        text-align: right;
        border: none;
        background: transparent;
        color: inherit;
      }
      @media (prefers-color-scheme: dark) {
        .context-reminder.subtle {
          color: #aaa;
        }
      }
      
      /* å¼•ç”¨æ ·å¼ */
      .citations {
        margin-top: 16px;
        padding: 16px 20px 16px 25px;
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        border-radius: 4px;
        font-size: 0.9em;
      }
      
      .citations h4 {
        margin: 0 0 8px 0;
        color: #007bff;
        font-size: 0.95em;
      }
      
      .citations ol {
        margin: 0;
        padding-left: 25px;
      }
      
      .citations li {
        margin-bottom: 8px;
        line-height: 1.5;
        padding: 2px 0;
      }
      
      .citations a {
        color: #007bff;
        text-decoration: none;
        cursor: pointer;
        word-break: break-all;
      }
      
      .citations a:hover {
        text-decoration: underline;
        color: #0056b3;
      }
      
      .citations a:active {
        color: #004085;
      }
      
      /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
      @media (max-width: 768px) {
        .citations {
          padding: 14px 16px 14px 21px;
        }
        
        .citations ol {
          padding-left: 21px;
        }
        
        .disclaimer {
          padding: 14px 16px 14px 21px;
        }
        
        .citations a {
          display: inline-block;
          padding: 2px 4px;
          margin: 1px 0;
          border-radius: 3px;
          background-color: rgba(0, 123, 255, 0.1);
          transition: background-color 0.2s;
        }
        
        .citations a:hover {
          background-color: rgba(0, 123, 255, 0.2);
        }
        
        .citations a:active {
          background-color: rgba(0, 123, 255, 0.3);
        }
      }
      
      .disclaimer {
        margin-top: 12px;
        padding: 16px 20px 16px 25px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        font-size: 0.9em;
        color: #856404;
        line-height: 1.5;
      }
      
      /* å°å±å¹•ä¼˜åŒ– */
      @media (max-width: 480px) {
        .citations {
          padding: 12px 14px 12px 19px;
        }
        
        .citations ol {
          padding-left: 19px;
        }
        
        .disclaimer {
          padding: 12px 14px 12px 19px;
        }
      }
      
      @media (prefers-color-scheme: dark) {
        .citations {
          background: #2d3748;
          border-left-color: #63b3ed;
        }
        
        .citations h4 {
          color: #63b3ed;
        }
        
        .citations a {
          color: #63b3ed;
          cursor: pointer;
        }
        
        .citations a:hover {
          color: #4299e1;
          text-decoration: underline;
        }
        
        .citations a:active {
          color: #3182ce;
        }
        
        .disclaimer {
          background: #744210;
          border-color: #d69e2e;
          color: #fbd38d;
        }
      }
      
      /* æ·±åº¦ç¾åŒ–çš„å®Œç¾åœ†å½¢æŒ‰é’® */
      #dataAnalysisBtn, #clearBtn, #sendBtn {
        width: 48px;
        height: 48px;
        min-width: 48px;
        min-height: 48px;
        max-width: 48px;
        max-height: 48px;
        border-radius: 50% !important;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        position: relative;
        overflow: hidden;
        font-size: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        flex-shrink: 0;
        outline: none;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }
      
      /* æ•°æ®åˆ†ææŒ‰é’® - æ·±åº¦ç¾åŒ– */
      #dataAnalysisBtn {
        background: linear-gradient(145deg, #ffffff 0%, #f1f3f4 100%);
        color: #5f6368;
        margin-right: 16px;
        border: 2px solid transparent;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
      }
      
      #dataAnalysisBtn:hover {
        background: linear-gradient(145deg, #e8f0fe 0%, #d2e3fc 100%);
        color: #1a73e8;
        transform: translateY(-3px) scale(1.08);
        box-shadow: 0 8px 24px rgba(26, 115, 232, 0.25),
                    0 4px 8px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9);
        border-color: rgba(26, 115, 232, 0.2);
      }
      
      #dataAnalysisBtn.active {
        background: linear-gradient(145deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 12px 32px rgba(139, 92, 246, 0.4),
                    0 4px 8px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
        border-color: rgba(139, 92, 246, 0.3);
      }
      
      #dataAnalysisBtn.active:hover {
        background: linear-gradient(145deg, #7c3aed 0%, #6d28d9 100%);
        transform: translateY(-4px) scale(1.1);
        box-shadow: 0 16px 40px rgba(139, 92, 246, 0.5),
                    0 8px 16px rgba(0, 0, 0, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }
      
      /* æ¸…é™¤æŒ‰é’® - æ·±åº¦ç¾åŒ– */
      #clearBtn {
        background: linear-gradient(145deg, #fafafa 0%, #f0f0f0 100%);
        color: #5f6368;
        margin-right: 12px;
        border: 2px solid transparent;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
      }
      
      #clearBtn:hover {
        background: linear-gradient(145deg, #ffebee 0%, #ffcdd2 100%);
        color: #d32f2f;
        transform: translateY(-3px) scale(1.08);
        box-shadow: 0 8px 24px rgba(211, 47, 47, 0.25),
                    0 4px 8px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.9);
        border-color: rgba(211, 47, 47, 0.2);
      }
      
      /* å‘é€æŒ‰é’® - æ·±åº¦ç¾åŒ– */
      #sendBtn {
        background: linear-gradient(145deg, #1a73e8 0%, #1557b0 100%);
        color: white;
        border: 2px solid transparent;
        box-shadow: 0 4px 16px rgba(26, 115, 232, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      
      #sendBtn:hover {
        background: linear-gradient(145deg, #1557b0 0%, #0d47a1 100%);
        transform: translateY(-3px) scale(1.08);
        box-shadow: 0 8px 24px rgba(26, 115, 232, 0.4),
                    0 4px 8px rgba(0, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border-color: rgba(26, 115, 232, 0.3);
      }
      
      #sendBtn:disabled {
        background: linear-gradient(145deg, #9aa0a6 0%, #80868b 100%);
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-color: transparent;
      }
      
      /* æŒ‰é’®ç»„æ ·å¼ */
      .button-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      
      /* å›¾æ ‡æ ·å¼ - æ·±åº¦ç¾åŒ– */
      .icon {
        font-size: 22px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
      }
      
      /* é«˜çº§æ¶Ÿæ¼ªæ•ˆæœ */
      #dataAnalysisBtn::before,
      #clearBtn::before,
      #sendBtn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 70%, transparent 100%);
        transform: translate(-50%, -50%);
        transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        pointer-events: none;
      }
      
      #dataAnalysisBtn:active::before,
      #clearBtn:active::before,
      #sendBtn:active::before {
        width: 120%;
        height: 120%;
        opacity: 0;
      }
      
      /* æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
      #dataAnalysisBtn:active,
      #clearBtn:active,
      #sendBtn:active {
        transform: translateY(-1px) scale(0.98);
        transition: all 0.1s ease;
      }
      
      /* å›¾æ ‡æ‚¬åœæ•ˆæœ */
      #dataAnalysisBtn:hover .icon,
      #clearBtn:hover .icon,
      #sendBtn:hover .icon {
        transform: scale(1.1);
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }
      
      /* æ·±è‰²æ¨¡å¼é€‚é… - æ·±åº¦ç¾åŒ– */
      @media (prefers-color-scheme: dark) {
        #dataAnalysisBtn {
          background: linear-gradient(145deg, #2d3748 0%, #1a202c 100%);
          color: #a0aec0;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3),
                      inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        #dataAnalysisBtn:hover {
          background: linear-gradient(145deg, #2b6cb0 0%, #2c5282 100%);
          color: #90cdf4;
          box-shadow: 0 8px 24px rgba(43, 108, 176, 0.3),
                      0 4px 8px rgba(0, 0, 0, 0.2),
                      inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        #dataAnalysisBtn.active {
          background: linear-gradient(145deg, #8b5cf6 0%, #7c3aed 100%);
          color: white;
          box-shadow: 0 12px 32px rgba(139, 92, 246, 0.4),
                      0 4px 8px rgba(0, 0, 0, 0.2),
                      inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        #clearBtn {
          background: linear-gradient(145deg, #4a5568 0%, #2d3748 100%);
          color: #a0aec0;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3),
                      inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        #clearBtn:hover {
          background: linear-gradient(145deg, #742a2a 0%, #5a1a1a 100%);
          color: #feb2b2;
          box-shadow: 0 8px 24px rgba(116, 42, 42, 0.3),
                      0 4px 8px rgba(0, 0, 0, 0.2),
                      inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        #sendBtn {
          background: linear-gradient(145deg, #3182ce 0%, #2c5282 100%);
          box-shadow: 0 4px 16px rgba(49, 130, 206, 0.3),
                      inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        #sendBtn:hover {
          background: linear-gradient(145deg, #2c5282 0%, #2a4365 100%);
          box-shadow: 0 8px 24px rgba(44, 82, 130, 0.4),
                      0 4px 8px rgba(0, 0, 0, 0.2),
                      inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
      }
      
    </style>

    <!-- Third-party libs å¤–éƒ¨åº“ï¼ˆdefer é¿å…é˜»å¡æ¸²æŸ“ï¼‰ -->
    <script
      src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"
      defer
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js" defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-python.min.js"
      defer
    ></script>
  </head>

  <body>
    <!-- Chat container èŠå¤©å®¹å™¨ -->
    <div class="chat-container">
      <!-- Message list æ¶ˆæ¯åˆ—è¡¨ï¼šä½¿ç”¨å¯è®¿é—®æ€§è¯­ä¹‰ -->
      <div
        class="message-list"
        id="messageList"
        role="log"
        aria-live="polite"
        aria-relevant="additions"
      ></div>

      <!-- Input area è¾“å…¥åŒº -->
      <div class="input-container">
        <button
          type="button"
          id="dataAnalysisBtn"
          onclick="toggleDataAnalysis()"
          aria-label="æ•°æ®åˆ†ææ¨¡å¼"
          title="ç‚¹å‡»å¯ç”¨æ•°æ®åˆ†ææ¨¡å¼ï¼ŒAIå°†åˆ†ææ‚¨è¿‘ä¸‰ä¸ªæœˆçš„å¥åº·æ•°æ®"
        >
          <span class="icon">ğŸ“Š</span>
        </button>
        <textarea
          id="userInput"
          placeholder="è¯·è¾“å…¥æ‚¨çš„å¥åº·é—®é¢˜..."
          autocomplete="off"
          aria-label="è¾“å…¥æ‚¨çš„å¥åº·é—®é¢˜"
          onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
          rows="1"
        ></textarea>
        <div class="button-group">
          <button
            type="button"
            id="clearBtn"
            onclick="clearSession()"
            aria-label="æ¸…é™¤ä¼šè¯"
            title="æ¸…é™¤å¯¹è¯å†å²"
          >
            <span class="icon">ğŸ—‘ï¸</span>
          </button>
          <button
            type="button"
            id="sendBtn"
            onclick="sendMessage()"
            aria-label="å‘é€æ¶ˆæ¯"
          >
            <span class="icon">â¤</span>
          </button>
        </div>
    

    <script>
      // Wait for deferred libs ç­‰ç¬¬ä¸‰æ–¹åº“åŠ è½½å®Œæˆ
      window.addEventListener("DOMContentLoaded", () => {
        // marked config: soft line breaks & safer defaults
        if (window.marked) {
          marked.setOptions({ breaks: true, mangle: false, headerIds: false });
        }
        
        // æ¢å¤ä¼šè¯ID
        restoreSessionId();
        
        generateGreeting();
        
        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        const textarea = document.getElementById('userInput');
        if (textarea) {
          textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
          });
        }

        // ç›‘å¬æ‰€æœ‰é“¾æ¥ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿åœ¨é»˜è®¤æµè§ˆå™¨ä¸­æ‰“å¼€
        document.addEventListener('click', function(e) {
          if (e.target.tagName === 'A' && e.target.href) {
            e.preventDefault();
            // åœ¨é»˜è®¤æµè§ˆå™¨ä¸­æ‰“å¼€é“¾æ¥
            if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Browser) {
              // å¦‚æœæ˜¯åœ¨Capacitorç¯å¢ƒä¸­ï¼Œä½¿ç”¨Browseræ’ä»¶
              window.Capacitor.Plugins.Browser.open({ url: e.target.href });
            } else {
              // åœ¨æ™®é€šæµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œä½¿ç”¨window.open
              window.open(e.target.href, '_blank', 'noopener,noreferrer');
            }
          }
        });
      });

      /**
       * Sanitize + render Markdown å®‰å…¨æ¸²æŸ“ Markdown
       * - ä½¿ç”¨ DOMPurify è¿›è¡Œ XSS è¿‡æ»¤
       */
      function renderMarkdownSafe(mdText) {
        const html = window.marked ? marked.parse(mdText || "") : mdText || "";
        let sanitizedHtml = window.DOMPurify
          ? DOMPurify.sanitize(html, { 
              USE_PROFILES: { html: true },
              ADD_ATTR: ['target', 'rel'] // å…è®¸targetå’Œrelå±æ€§
            })
          : html;
        
        // ç¡®ä¿æ‰€æœ‰å¤–éƒ¨é“¾æ¥éƒ½åœ¨æ–°çª—å£æ‰“å¼€
        sanitizedHtml = sanitizedHtml.replace(/<a\s+([^>]*?)href="([^"]*?)"([^>]*?)>/gi, (match, before, href, after) => {
          // å¦‚æœæ˜¯å¤–éƒ¨é“¾æ¥ï¼Œç¡®ä¿æœ‰target="_blank"
          if (href.startsWith('http') && !match.includes('target=')) {
            return `<a ${before}href="${href}"${after} target="_blank" rel="noopener noreferrer">`;
          }
          return match;
        });
        
        return sanitizedHtml;
      }

      // ä¼šè¯ç®¡ç†
      let currentSessionId = null;
      
      // æ•°æ®åˆ†ææ¨¡å¼çŠ¶æ€
      let dataAnalysisMode = false;
      let userData = null;
      
      // ç”Ÿæˆä¼šè¯ID
      function generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      // è·å–æˆ–åˆ›å»ºä¼šè¯ID
      function getSessionId() {
        if (!currentSessionId) {
          currentSessionId = generateSessionId();
          // ä¿å­˜åˆ°localStorage
          localStorage.setItem('qwen_session_id', currentSessionId);
        }
        return currentSessionId;
      }
      
      // ä»localStorageæ¢å¤ä¼šè¯ID
      function restoreSessionId() {
        const saved = localStorage.getItem('qwen_session_id');
        if (saved) {
          currentSessionId = saved;
        }
      }
      
      // åˆ‡æ¢æ•°æ®åˆ†ææ¨¡å¼
      function toggleDataAnalysis() {
        dataAnalysisMode = !dataAnalysisMode;
        const btn = document.getElementById('dataAnalysisBtn');
        
        if (dataAnalysisMode) {
          btn.classList.add('active');
          btn.title = 'æ•°æ®åˆ†ææ¨¡å¼å·²å¯ç”¨ï¼ŒAIå°†åˆ†ææ‚¨è¿‘ä¸‰ä¸ªæœˆçš„å¥åº·æ•°æ®';
          // è·å–ç”¨æˆ·æ•°æ®
          fetchUserData();
        } else {
          btn.classList.remove('active');
          btn.title = 'ç‚¹å‡»å¯ç”¨æ•°æ®åˆ†ææ¨¡å¼ï¼ŒAIå°†åˆ†ææ‚¨è¿‘ä¸‰ä¸ªæœˆçš„å¥åº·æ•°æ®';
          userData = null;
        }
      }
      
      // å¯ç”¨æ•°æ®åˆ†ææ¨¡å¼ï¼ˆåç«¯ä¼šç›´æ¥è¯»å–æ•°æ®åº“ï¼‰
      function fetchUserData() {
        // æ˜¾ç¤ºæ•°æ®åˆ†ææ¨¡å¼å¯ç”¨æç¤º
        addMessage('âœ… æ•°æ®åˆ†ææ¨¡å¼å·²å¯ç”¨ï¼AIå°†ç›´æ¥ä»æ•°æ®åº“è·å–æ‚¨è¿‘ä¸‰ä¸ªæœˆçš„å¥åº·æ•°æ®è¿›è¡Œåˆ†æã€‚', 'bot');
        console.log('æ•°æ®åˆ†ææ¨¡å¼å·²å¯ç”¨ï¼Œåç«¯å°†ç›´æ¥è¯»å–æ•°æ®åº“');
      }
      
      
      // æ¸…é™¤ä¼šè¯
      async function clearSession() {
        try {
          const apiBase = window.__API_BASE__ || (window.parent && window.parent.__API_BASE__) || 'https://app.zdelf.cn';
          const baseUrl = apiBase.endsWith('/') ? apiBase.slice(0, -1) : apiBase;
          
          const response = await fetch(`${baseUrl}/deepseek/clear_session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: currentSessionId })
          });
          
          if (response.ok) {
            // æ¸…é™¤æœ¬åœ°ä¼šè¯ID
            currentSessionId = null;
            localStorage.removeItem('qwen_session_id');
            
            // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
            const msgList = document.getElementById("messageList");
            msgList.innerHTML = '';
            
            // é‡æ–°ç”Ÿæˆé—®å€™
            generateGreeting();
            
            console.log('ä¼šè¯å·²æ¸…é™¤');
          }
        } catch (error) {
          console.error('æ¸…é™¤ä¼šè¯å¤±è´¥:', error);
        }
      }

      // åˆå§‹é—®å€™
      function generateGreeting() {
        const now = new Date();
        const hour = now.getHours();
        console.log('å½“å‰æ—¶é—´:', now.toLocaleString(), 'å°æ—¶:', hour);
        
        let greet = "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å¥åº·åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¥åº·é—®é¢˜å°½ç®¡é—®æˆ‘å“¦~";
        if (hour >= 5 && hour < 11) {
          greet = "æ—©ä¸Šå¥½ â˜€ï¸ï¼Œç¥ä½ æœ‰æ„‰å¿«çš„ä¸€å¤©ï¼æœ‰ä»€ä¹ˆå¥åº·é—®é¢˜å¯ä»¥é—®æˆ‘";
        } else if (hour >= 11 && hour < 14) {
          greet = "ä¸­åˆå¥½ ğŸµï¼Œæ³¨æ„è¡¥æ°´ï¼Œæœ‰ä»€ä¹ˆå¥åº·é—®é¢˜æƒ³é—®çš„ï¼Ÿ";
        } else if (hour >= 14 && hour < 18) {
          greet = "ä¸‹åˆå¥½ ğŸŒ¿ï¼Œä¸Šåˆè¿‡å¾—å¦‚ä½•å‘¢ï¼Ÿæœ‰ä»€ä¹ˆå¥åº·é—®é¢˜å¯ä»¥å’¨è¯¢æˆ‘";
        } else if (hour >= 18 && hour < 22) {
          greet = "æ™šä¸Šå¥½ ğŸŒ™ï¼Œä»Šå¤©æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿå¯ä»¥å‡†å¤‡ä¼‘æ¯å–½ï½æœ‰ä»€ä¹ˆå¥åº·é—®é¢˜å¯ä»¥é—®æˆ‘";
        } else {
          greet = "å¤œæ·±äº† ğŸŒƒï¼Œç¾å¥½çš„ä¸€å¤©è¿‡å»äº†ï¼Œæ—©ç‚¹ä¼‘æ¯å“¦ï½æœ‰ä»€ä¹ˆå¥åº·é—®é¢˜å¯ä»¥é—®æˆ‘";
        }
        addMessage(greet, "bot");
      }

      // æ‰“å­—ä¸­å ä½æ°”æ³¡ typing bubble
      function addTypingBubble() {
        const msgList = document.getElementById("messageList");
        const wrap = document.createElement("div");
        wrap.className = "message bot typing";
        wrap.setAttribute("aria-label", "æ­£åœ¨å›å¤");
        wrap.innerHTML =
          '<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
        msgList.appendChild(wrap);
        msgList.scrollTop = msgList.scrollHeight;
        return wrap;
      }

      async function sendMessage() {
        const inputEl = document.getElementById("userInput");
        const btn = document.getElementById("sendBtn");
        const message = inputEl.value.trim();
        if (!message) return;

        inputEl.disabled = true;
        btn.disabled = true;

        addMessage(message, "user");
        inputEl.value = "";

        const thinkingMsg = addTypingBubble();

        try {
          // è·å–APIåŸºç¡€è·¯å¾„
          const apiBase = window.__API_BASE__ || (window.parent && window.parent.__API_BASE__) || 'https://app.zdelf.cn';
          const baseUrl = apiBase.endsWith('/') ? apiBase.slice(0, -1) : apiBase;
          
          // è·å–ä¼šè¯ID
          const sessionId = getSessionId();
          
          // æ„å»ºè¯·æ±‚æ•°æ®
          const requestData = { 
            message: message,
            session_id: sessionId
          };
          
          // å¦‚æœå¯ç”¨äº†æ•°æ®åˆ†ææ¨¡å¼ï¼Œæ·»åŠ åˆ†ææ¨¡å¼æ ‡å¿—
          if (dataAnalysisMode) {
            requestData.analysis_mode = true;
            // æ·»åŠ ç”¨æˆ·IDï¼Œåç«¯ä¼šç›´æ¥è¯»å–æ•°æ®åº“
            requestData.user_id = localStorage.getItem('userId') || 'default_user';
          }
          
          // é¦–å…ˆå°è¯•ä½¿ç”¨æµå¼æ¥å£
          const response = await fetch(
            `${baseUrl}/deepseek/chat_stream`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestData),
            }
          );

          if (response.ok) {
            // ç§»é™¤æ‰“å­—ä¸­çŠ¶æ€
            thinkingMsg.classList.remove("typing");

            // å¤„ç†æµå¼å“åº”
            await handleStreamResponse(thinkingMsg, response);

            if (window.Prism) Prism.highlightAll();
          } else {
            // æµå¼æ¥å£å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šæ¥å£ + æ‰“å­—æœºæ•ˆæœ
            await fallbackToLegacy(thinkingMsg, message, sessionId);
          }
        } catch (error) {
          // ç½‘ç»œé”™è¯¯ï¼Œä¹Ÿå›é€€åˆ°æ™®é€šæ¥å£
          await fallbackToLegacy(thinkingMsg, message, getSessionId());
        } finally {
          inputEl.disabled = false;
          btn.disabled = false;
          inputEl.focus();
        }
      }

      // å›é€€åˆ°æ™®é€šæ¥å£ + æ‰“å­—æœºæ•ˆæœ
      async function fallbackToLegacy(thinkingMsg, message, sessionId) {
        try {
          // è·å–APIåŸºç¡€è·¯å¾„
          const apiBase = window.__API_BASE__ || (window.parent && window.parent.__API_BASE__) || 'https://app.zdelf.cn';
          const baseUrl = apiBase.endsWith('/') ? apiBase.slice(0, -1) : apiBase;
          
          // æ„å»ºè¯·æ±‚æ•°æ®
          const requestData = { 
            message: message,
            session_id: sessionId
          };
          
          // å¦‚æœå¯ç”¨äº†æ•°æ®åˆ†ææ¨¡å¼ï¼Œæ·»åŠ åˆ†ææ¨¡å¼æ ‡å¿—
          if (dataAnalysisMode) {
            requestData.analysis_mode = true;
            // æ·»åŠ ç”¨æˆ·IDï¼Œåç«¯ä¼šç›´æ¥è¯»å–æ•°æ®åº“
            requestData.user_id = localStorage.getItem('userId') || 'default_user';
          }
          
          const response = await fetch(
            `${baseUrl}/deepseek/chat`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestData),
            }
          );

          const data = await response.json().catch(() => ({}));
          if (response.ok && data && typeof data.reply === "string") {
            thinkingMsg.classList.remove("typing");

            // å¯åŠ¨æ‰“å­—æœºæ•ˆæœ
            await typewriterEffect(thinkingMsg, data.reply);

            if (window.Prism) Prism.highlightAll();
          } else {
            thinkingMsg.classList.remove("typing");
            thinkingMsg.textContent =
              "âŒ å‡ºé”™äº†ï¼š" +
              (data.error || response.status + " " + response.statusText);
          }
        } catch (error) {
          thinkingMsg.classList.remove("typing");
          thinkingMsg.textContent =
            "âš ï¸ æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼š" +
            (error && error.message ? error.message : "Network error");
        }
      }

      // å¤„ç†æµå¼å“åº”
      async function handleStreamResponse(element, response) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";
        let fullText = "";

        // åˆ›å»ºå†…å®¹å®¹å™¨
        const content = document.createElement("div");
        content.className = "msg-content";
        element.appendChild(content);

        try {
          while (true) {
            const { done, value } = await reader.read();

            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const dataStr = line.slice(6);
                if (dataStr === "[DONE]") {
                  // æœ€ç»ˆæ¸²æŸ“å®Œæ•´çš„markdownå¹¶é«˜äº®ä»£ç 
                  content.innerHTML = renderMarkdownSafe(fullText);
                  if (window.Prism) Prism.highlightAll();
                  return;
                }

                try {
                  const data = JSON.parse(dataStr);
                  if (data.type === "content" && data.content) {
                    fullText += data.content;
                    // å®æ—¶æ˜¾ç¤ºå½“å‰å†…å®¹
                    content.innerHTML = renderMarkdownSafe(fullText);

                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    const msgList = document.getElementById("messageList");
                    msgList.scrollTop = msgList.scrollHeight;
                  } else if (data.type === "citations" && data.content) {
                    // å¤„ç†å¼•ç”¨ä¿¡æ¯
                    fullText += data.content;
                    content.innerHTML = renderMarkdownSafe(fullText);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    const msgList = document.getElementById("messageList");
                    msgList.scrollTop = msgList.scrollHeight;
                  } else if (data.type === "disclaimer" && data.content) {
                    // å¤„ç†å…è´£å£°æ˜
                    fullText += data.content;
                    content.innerHTML = renderMarkdownSafe(fullText);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    const msgList = document.getElementById("messageList");
                    msgList.scrollTop = msgList.scrollHeight;
                  } else if (data.type === "error") {
                    content.innerHTML = "âŒ é”™è¯¯ï¼š" + data.error;
                    return;
                  }
                } catch (e) {
                  console.warn("è§£ææµæ•°æ®å¤±è´¥:", e);
                }
              }
            }
          }
        } catch (error) {
          console.error("æµå¼å“åº”å¤„ç†é”™è¯¯:", error);
          content.innerHTML = "âš ï¸ å“åº”å¤„ç†é”™è¯¯ï¼š" + error.message;
        } finally {
          reader.releaseLock();
        }
      }

      // æ‰“å­—æœºæ•ˆæœå‡½æ•°
      async function typewriterEffect(element, text) {
        // æ¸…ç©ºå…ƒç´ å†…å®¹
        element.innerHTML = "";

        // åˆ›å»ºå†…å®¹å®¹å™¨
        const content = document.createElement("div");
        content.className = "msg-content";
        element.appendChild(content);

        // é€å­—æ˜¾ç¤ºæ–‡æœ¬
        for (let i = 0; i < text.length; i++) {
          const char = text[i];

          // å¤„ç†æ¢è¡Œç¬¦
          if (char === "\n") {
            content.innerHTML += "<br>";
          } else {
            // æ¸²æŸ“å½“å‰æ–‡æœ¬ï¼ˆåŒ…å«å·²æ˜¾ç¤ºçš„å­—ç¬¦ï¼‰
            const currentText = text.substring(0, i + 1);
            content.innerHTML = renderMarkdownSafe(currentText);
          }

          // æ»šåŠ¨åˆ°åº•éƒ¨
          const msgList = document.getElementById("messageList");
          msgList.scrollTop = msgList.scrollHeight;

          // åŠ¨æ€è°ƒæ•´æ‰“å­—é€Ÿåº¦ï¼šæ ‡ç‚¹ç¬¦å·ç¨æ…¢ï¼Œæ™®é€šå­—ç¬¦ç¨å¿«
          let currentSpeed = 30; // é»˜è®¤30ms
          if (
            ["ã€‚", "ï¼", "ï¼Ÿ", "ï¼›", "ï¼š", ".", "!", "?", ";", ":"].includes(
              char
            )
          ) {
            currentSpeed = 60; // æ ‡ç‚¹ç¬¦å·åœé¡¿æ—¶é—´æ›´é•¿
          } else if (["ï¼Œ", "ã€", ",", " "].includes(char)) {
            currentSpeed = 45; // é€—å·å’Œç©ºæ ¼ç¨æ…¢
          }

          // ç­‰å¾…ä¸€æ®µæ—¶é—´å†æ˜¾ç¤ºä¸‹ä¸€ä¸ªå­—ç¬¦
          await new Promise((resolve) => setTimeout(resolve, currentSpeed));
        }

        // æœ€ç»ˆæ¸²æŸ“å®Œæ•´çš„markdownå¹¶é«˜äº®ä»£ç 
        content.innerHTML = renderMarkdownSafe(text);
        if (window.Prism) Prism.highlightAll();
      }

      // åœæ­¢æ‰“å­—åŠŸèƒ½
      function stopTyping() {
        if (currentTypingTask !== null) {
          currentTypingTask = "stop";
          const stopBtn = document.getElementById("stopTyping");
          stopBtn.style.display = "none";
        }
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
      function addMessage(text, sender, returnElement = false) {
        const msgList = document.getElementById("messageList");
        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + sender;

        // avatarï¼ˆä»…æœºå™¨äººæ˜¾ç¤ºå¤´åƒï¼Œç”¨æˆ·ä¸æ˜¾ç¤ºï¼‰
        let avatar = null;
        if (sender === 'bot') {
          avatar = document.createElement('img');
          avatar.className = 'avatar';
          avatar.src = '../images/doctor.png';
          avatar.alt = 'Doctor';
        }

        const content = document.createElement("div");
        content.className = "msg-content";

        if (sender === "bot") {
          content.innerHTML = renderMarkdownSafe(text);
        } else {
          // User text as plain text to avoid injection ç”¨æˆ·æ¶ˆæ¯æŒ‰çº¯æ–‡æœ¬æ’å…¥
          content.textContent = text;
        }

        // iMessage-like layout: avatar + bubbleï¼ˆä»…botå¸¦å¤´åƒï¼‰
        if (avatar) msgDiv.appendChild(avatar);
        msgDiv.appendChild(content);
        msgList.appendChild(msgDiv);
        msgList.scrollTop = msgList.scrollHeight;
        if (window.Prism) Prism.highlightAll();
        return returnElement ? msgDiv : undefined;
      }
    </script>
  </body>
</html>
