<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>ä¸ªäººåšå®¢</title>

    <!-- Viewport & color scheme è§†å£ä¸é¢œè‰²æ–¹æ¡ˆ -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#ffffff" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#121212"
    />

    <!-- Stylesheets æ ·å¼è¡¨ -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism.css"
    />
    <link rel="stylesheet" href="../statics/css/deepseek.css" />
    <style>
      .context-reminder.subtle {
        font-size: 0.8em;
        opacity: 0.6;
        max-width: none;
        margin-top: 6px;
        text-align: right;
        border: none;
        background: transparent;
        color: inherit;
      }
      @media (prefers-color-scheme: dark) {
        .context-reminder.subtle {
          color: #aaa;
        }
      }
      
    </style>

    <!-- Third-party libs å¤–éƒ¨åº“ï¼ˆdefer é¿å…é˜»å¡æ¸²æŸ“ï¼‰ -->
    <script
      src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"
      defer
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js" defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-python.min.js"
      defer
    ></script>
  </head>

  <body>
    <!-- Chat container èŠå¤©å®¹å™¨ -->
    <div class="chat-container">
      <!-- Message list æ¶ˆæ¯åˆ—è¡¨ï¼šä½¿ç”¨å¯è®¿é—®æ€§è¯­ä¹‰ -->
      <div
        class="message-list"
        id="messageList"
        role="log"
        aria-live="polite"
        aria-relevant="additions"
      ></div>

      <!-- Input area è¾“å…¥åŒº -->
      <div class="input-container">
        <textarea
          id="userInput"
          placeholder="è¯·è¾“å…¥æ‚¨çš„å¥åº·é—®é¢˜..."
          autocomplete="off"
          aria-label="è¾“å…¥æ‚¨çš„å¥åº·é—®é¢˜"
          onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
          rows="1"
        ></textarea>
        <button
          type="button"
          id="sendBtn"
          onclick="sendMessage()"
          aria-label="å‘é€æ¶ˆæ¯"
        >
          å‘é€
        </button>
    

    <script>
      // Wait for deferred libs ç­‰ç¬¬ä¸‰æ–¹åº“åŠ è½½å®Œæˆ
      window.addEventListener("DOMContentLoaded", () => {
        // marked config: soft line breaks & safer defaults
        if (window.marked) {
          marked.setOptions({ breaks: true, mangle: false, headerIds: false });
        }
        generateGreeting();
        
        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        const textarea = document.getElementById('userInput');
        if (textarea) {
          textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
          });
        }
      });

      /**
       * Sanitize + render Markdown å®‰å…¨æ¸²æŸ“ Markdown
       * - ä½¿ç”¨ DOMPurify è¿›è¡Œ XSS è¿‡æ»¤
       */
      function renderMarkdownSafe(mdText) {
        const html = window.marked ? marked.parse(mdText || "") : mdText || "";
        return window.DOMPurify
          ? DOMPurify.sanitize(html, { USE_PROFILES: { html: true } })
          : html;
      }

      // åˆå§‹é—®å€™
      function generateGreeting() {
        const hour = new Date().getHours();
        let greet = "æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¥åº·é—®é¢˜å°½ç®¡é—®æˆ‘å“¦~";
        if (hour >= 5 && hour < 11)
          greet = "æ—©ä¸Šå¥½ â˜€ï¸ï¼Œæˆ‘å¯ä»¥å¸®ä½ åˆ†æé¥®é£Ÿã€ä½œæ¯æˆ–ä½“æ£€æŠ¥å‘Šã€‚";
        else if (hour < 14) greet = "ä¸­åˆå¥½ ğŸµï¼Œæ³¨æ„è¡¥æ°´ï¼Œæœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Ÿ";
        else if (hour < 18)
          greet = "ä¸‹åˆå¥½ ğŸŒ¿ï¼Œéœ€è¦æˆ‘çœ‹çœ‹ä½ çš„è®­ç»ƒ/é¥®é£Ÿè®¡åˆ’å—ï¼Ÿ";
        else greet = "æ™šä¸Šå¥½ ğŸŒ™ï¼Œä»Šå¤©æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ åšä¸ªæ€»ç»“ã€‚";
        addMessage(greet, "bot");
      }

      // æ‰“å­—ä¸­å ä½æ°”æ³¡ typing bubble
      function addTypingBubble() {
        const msgList = document.getElementById("messageList");
        const wrap = document.createElement("div");
        wrap.className = "message bot typing";
        wrap.setAttribute("aria-label", "æ­£åœ¨å›å¤");
        wrap.innerHTML =
          '<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
        msgList.appendChild(wrap);
        msgList.scrollTop = msgList.scrollHeight;
        return wrap;
      }

      async function sendMessage() {
        const inputEl = document.getElementById("userInput");
        const btn = document.getElementById("sendBtn");
        const message = inputEl.value.trim();
        if (!message) return;

        inputEl.disabled = true;
        btn.disabled = true;

        addMessage(message, "user");
        inputEl.value = "";

        const thinkingMsg = addTypingBubble();

        try {
          // é¦–å…ˆå°è¯•ä½¿ç”¨æµå¼æ¥å£
          const response = await fetch(
            "/deepseek/chat_stream",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message }),
            }
          );

          if (response.ok) {
            // ç§»é™¤æ‰“å­—ä¸­çŠ¶æ€
            thinkingMsg.classList.remove("typing");

            // å¤„ç†æµå¼å“åº”
            await handleStreamResponse(thinkingMsg, response);

            if (window.Prism) Prism.highlightAll();
          } else {
            // æµå¼æ¥å£å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šæ¥å£ + æ‰“å­—æœºæ•ˆæœ
            await fallbackToLegacy(thinkingMsg, message);
          }
        } catch (error) {
          // ç½‘ç»œé”™è¯¯ï¼Œä¹Ÿå›é€€åˆ°æ™®é€šæ¥å£
          await fallbackToLegacy(thinkingMsg, message);
        } finally {
          inputEl.disabled = false;
          btn.disabled = false;
          inputEl.focus();
        }
      }

      // å›é€€åˆ°æ™®é€šæ¥å£ + æ‰“å­—æœºæ•ˆæœ
      async function fallbackToLegacy(thinkingMsg, message) {
        try {
          const response = await fetch(
            "/deepseek/chat",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message }),
            }
          );

          const data = await response.json().catch(() => ({}));
          if (response.ok && data && typeof data.reply === "string") {
            thinkingMsg.classList.remove("typing");

            // å¯åŠ¨æ‰“å­—æœºæ•ˆæœ
            await typewriterEffect(thinkingMsg, data.reply);

            if (window.Prism) Prism.highlightAll();
          } else {
            thinkingMsg.classList.remove("typing");
            thinkingMsg.textContent =
              "âŒ å‡ºé”™äº†ï¼š" +
              (data.error || response.status + " " + response.statusText);
          }
        } catch (error) {
          thinkingMsg.classList.remove("typing");
          thinkingMsg.textContent =
            "âš ï¸ æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼š" +
            (error && error.message ? error.message : "Network error");
        }
      }

      // å¤„ç†æµå¼å“åº”
      async function handleStreamResponse(element, response) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";
        let fullText = "";

        // åˆ›å»ºå†…å®¹å®¹å™¨
        const content = document.createElement("div");
        content.className = "msg-content";
        element.appendChild(content);

        try {
          while (true) {
            const { done, value } = await reader.read();

            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const dataStr = line.slice(6);
                if (dataStr === "[DONE]") {
                  // æœ€ç»ˆæ¸²æŸ“å®Œæ•´çš„markdownå¹¶é«˜äº®ä»£ç 
                  content.innerHTML = renderMarkdownSafe(fullText);
                  if (window.Prism) Prism.highlightAll();
                  return;
                }

                try {
                  const data = JSON.parse(dataStr);
                  if (data.type === "content" && data.content) {
                    fullText += data.content;
                    // å®æ—¶æ˜¾ç¤ºå½“å‰å†…å®¹
                    content.innerHTML = renderMarkdownSafe(fullText);

                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    const msgList = document.getElementById("messageList");
                    msgList.scrollTop = msgList.scrollHeight;
                  } else if (data.type === "error") {
                    content.innerHTML = "âŒ é”™è¯¯ï¼š" + data.error;
                    return;
                  }
                } catch (e) {
                  console.warn("è§£ææµæ•°æ®å¤±è´¥:", e);
                }
              }
            }
          }
        } catch (error) {
          console.error("æµå¼å“åº”å¤„ç†é”™è¯¯:", error);
          content.innerHTML = "âš ï¸ å“åº”å¤„ç†é”™è¯¯ï¼š" + error.message;
        } finally {
          reader.releaseLock();
        }
      }

      // æ‰“å­—æœºæ•ˆæœå‡½æ•°
      async function typewriterEffect(element, text) {
        // æ¸…ç©ºå…ƒç´ å†…å®¹
        element.innerHTML = "";

        // åˆ›å»ºå†…å®¹å®¹å™¨
        const content = document.createElement("div");
        content.className = "msg-content";
        element.appendChild(content);

        // é€å­—æ˜¾ç¤ºæ–‡æœ¬
        for (let i = 0; i < text.length; i++) {
          const char = text[i];

          // å¤„ç†æ¢è¡Œç¬¦
          if (char === "\n") {
            content.innerHTML += "<br>";
          } else {
            // æ¸²æŸ“å½“å‰æ–‡æœ¬ï¼ˆåŒ…å«å·²æ˜¾ç¤ºçš„å­—ç¬¦ï¼‰
            const currentText = text.substring(0, i + 1);
            content.innerHTML = renderMarkdownSafe(currentText);
          }

          // æ»šåŠ¨åˆ°åº•éƒ¨
          const msgList = document.getElementById("messageList");
          msgList.scrollTop = msgList.scrollHeight;

          // åŠ¨æ€è°ƒæ•´æ‰“å­—é€Ÿåº¦ï¼šæ ‡ç‚¹ç¬¦å·ç¨æ…¢ï¼Œæ™®é€šå­—ç¬¦ç¨å¿«
          let currentSpeed = 30; // é»˜è®¤30ms
          if (
            ["ã€‚", "ï¼", "ï¼Ÿ", "ï¼›", "ï¼š", ".", "!", "?", ";", ":"].includes(
              char
            )
          ) {
            currentSpeed = 60; // æ ‡ç‚¹ç¬¦å·åœé¡¿æ—¶é—´æ›´é•¿
          } else if (["ï¼Œ", "ã€", ",", " "].includes(char)) {
            currentSpeed = 45; // é€—å·å’Œç©ºæ ¼ç¨æ…¢
          }

          // ç­‰å¾…ä¸€æ®µæ—¶é—´å†æ˜¾ç¤ºä¸‹ä¸€ä¸ªå­—ç¬¦
          await new Promise((resolve) => setTimeout(resolve, currentSpeed));
        }

        // æœ€ç»ˆæ¸²æŸ“å®Œæ•´çš„markdownå¹¶é«˜äº®ä»£ç 
        content.innerHTML = renderMarkdownSafe(text);
        if (window.Prism) Prism.highlightAll();
      }

      // åœæ­¢æ‰“å­—åŠŸèƒ½
      function stopTyping() {
        if (currentTypingTask !== null) {
          currentTypingTask = "stop";
          const stopBtn = document.getElementById("stopTyping");
          stopBtn.style.display = "none";
        }
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
      function addMessage(text, sender, returnElement = false) {
        const msgList = document.getElementById("messageList");
        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + sender;

        // avatarï¼ˆä»…æœºå™¨äººæ˜¾ç¤ºå¤´åƒï¼Œç”¨æˆ·ä¸æ˜¾ç¤ºï¼‰
        let avatar = null;
        if (sender === 'bot') {
          avatar = document.createElement('img');
          avatar.className = 'avatar';
          avatar.src = '../images/doctor.png';
          avatar.alt = 'Doctor';
        }

        const content = document.createElement("div");
        content.className = "msg-content";

        if (sender === "bot") {
          content.innerHTML = renderMarkdownSafe(text);
        } else {
          // User text as plain text to avoid injection ç”¨æˆ·æ¶ˆæ¯æŒ‰çº¯æ–‡æœ¬æ’å…¥
          content.textContent = text;
        }

        // iMessage-like layout: avatar + bubbleï¼ˆä»…botå¸¦å¤´åƒï¼‰
        if (avatar) msgDiv.appendChild(avatar);
        msgDiv.appendChild(content);
        msgList.appendChild(msgDiv);
        msgList.scrollTop = msgList.scrollHeight;
        if (window.Prism) Prism.highlightAll();
        return returnElement ? msgDiv : undefined;
      }
    </script>
  </body>
</html>
